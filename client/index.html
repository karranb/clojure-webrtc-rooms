<head>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <style>
    .hidden {
      display: none
    }
  </style>
</head>

<body>
  <div class="name-section">
    User name: <input id="userNameInput" />
    <button id="setNameBtn">Set Name</button>
  </div>
  <div class="rooms-section hidden">
    Room name: <input id="roomNameInput" />
    <button id="newRoomBtn">Create Room</button>
    Rooms:
    <button id="getRoomsBtn">Get Rooms</button>
    <button id="quitRoomBtn">Quit Room</button>
    <div class="rooms-section__rooms">

    </div>
  </div>
</body>
<script>

const log = console.log

const connections = []

let roomId = null

let isHost = false

let name = null

const server = { urls: "stun:stun.l.google.com:19302" };

const socket = new WebSocket("ws://127.0.0.1:9090");

socket.onmessage = ({ data }) => {
  const parsedData = JSON.parse(data)
  switch (parsedData.title) {
    case 'GET-ROOMS':
      handleReceivedRooms(parsedData.rooms)
      return
    case 'SET-NAME':
      name = parsedData.name
      return
    case 'CREATE-ROOM':
      isHost = true
      roomId = parsedData.id
      return
    case 'CONNECTION-REQUEST':
      handleConnectionRequest(parsedData)
      return
    case 'CONNECTION-ANSWER':
      handleConnectionAnswer(parsedData)
      return
  }
}




const sendSocketMessage = data => {
  socket.send(JSON.stringify(data))
}

const peerConnection = (config = {}) => {

  const { pc, channel, connectionId } = config

  const setChannel = _channel => {
    _channel.onopen = () => log("Channel Opened")
    _channel.onmessage = e => log("Channel message", _channel, e.data)
    // set channel to connections
  }

  const updateListeners = () => {
    pc.ondatachannel = ({ channel }) => setChannel(channel)

    pc.oniceconnectionstatechange = e => {
      log(pc.iceConnectionState)
      if (pc.iceConnectionState === 'disconnected') {
        const data = {
          title: 'CONNECTION-CLOSED',
          connectionId,
          roomId,
        }
        sendSocketMessage(data)
      }
    }
  }

  if (!pc) {
    const newPc = new RTCPeerConnection({ iceServers: [server] })
    return peerConnection({ ...config, pc: newPc })
  }
  updateListeners()

  const newChannel = roomId => {
    const chatChannel = pc.createDataChannel("chat") 
    setChannel(chatChannel)

    pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);
    pc.onicecandidate = e => {
      if (e.candidate) return
      sendSocketMessage({
        title: "CONNECTION-REQUEST",
        offer: pc.localDescription.sdp,
        roomId,
      })
    }
    return peerConnection({...config, pc, channel: chatChannel})
  }

  const setChannelResponse = (answer, connectionId) => {
    const desc = new RTCSessionDescription({ type:"answer", sdp: answer });
    pc.setRemoteDescription(desc).catch(log);
    connections[0] = peerConnection({...config, pc, connectionId})
  }

  const newChannelResponse = (offer, connectionId) => {
    const desc = new RTCSessionDescription({ type: "offer", sdp: offer });

    pc.setRemoteDescription(desc)
      .then(() => pc.createAnswer()).then(d => pc.setLocalDescription(d))
      .catch(log);

    pc.onicecandidate = e => {
      if (e.candidate) return
      const data = {
        title: "CONNECTION-ANSWER",
        answer: pc.localDescription.sdp,
        connectionId,
      }
      sendSocketMessage(data)
    }
    return peerConnection({...config, pc, connectionId})
  }

  const getConnectionId = () => connectionId

  const closeChannel = () => {
    pc.close()
  }

  const sendPeerMessage = message => {
    channel.send(message);
  }

  return {
    closeChannel,
    newChannel,
    newChannelResponse,
    setChannelResponse,
    sendPeerMessage,
    getConnectionId,
  }
}


// const connection = peerConnection().newChannel


const $newRoomBtn = document.querySelector('#newRoomBtn')
const $getRoomsBtn = document.querySelector('#getRoomsBtn')
const $setNameBtn = document.querySelector('#setNameBtn')
const $quitRoomBtn = document.querySelector('#quitRoomBtn')

const $nameSection = document.querySelector('.name-section')
const $roomsSection = document.querySelector('.rooms-section')
const $roomsList = document.querySelector('.rooms-section__rooms')

const $userNameInput = document.querySelector('#userNameInput')
const $roomNameInput = document.querySelector('#roomNameInput')

$quitRoomBtn.addEventListener('click', () => {
  if (isHost) {
    const data = {
      title: "CLOSE-ROOM",
      id: roomId,
    }
    sendSocketMessage(data)
    return
  }
  connections[0].closeChannel()
})

const handleConnectionAnswer = data => {
  const connection = connections[0]
  connection.setChannelResponse(data.answer, data.connectionId)
}

const handleConnectionRequest = data => {
  const connection = peerConnection().newChannelResponse(data.offer, data.id)
  connections.push(connection)
}

const handleReceivedRooms = rooms => {
  rooms.forEach(room => {
    const button = document.createElement('button')
    button.innerText = room.name
    button.addEventListener('click', () => {
      roomId = room.id
      const connection = peerConnection().newChannel(room.id)
      connections.push(connection)
    })
    $roomsList.appendChild(button)
  })
}

$newRoomBtn.addEventListener('click', () => {
  const roomName = $roomNameInput.value
  const data = {
    title: "CREATE-ROOM",
    name: roomName,
  }
  sendSocketMessage(data)
})

$setNameBtn.addEventListener('click', () => {
  const userName = $userNameInput.value
  const data = {
    title: "SET-NAME",
    name: userName,
  }
  sendSocketMessage(data)
  $nameSection.classList.add('hidden')
  $roomsSection.classList.remove('hidden')
})

$getRoomsBtn.addEventListener('click', () => {
  const data = {
    title: "GET-ROOMS",
  }
  sendSocketMessage(data)
  $roomsList.innerHTML = ''
})


</script>